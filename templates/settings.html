<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Luge Timing Sequence</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            max-height: 100vh;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            height: calc(100vh - 2rem);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .settings-section {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            flex-shrink: 0;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            border-radius: 12px;
            padding: clamp(10px, 2vw, 14px) clamp(18px, 3.5vw, 28px);
            font-weight: bold;
            font-size: clamp(0.9rem, 2.2vw, 1rem);
            min-height: clamp(45px, 7vh, 55px);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 12px;
            padding: clamp(10px, 2vw, 14px) clamp(18px, 3.5vw, 28px);
            font-weight: bold;
            font-size: clamp(0.9rem, 2.2vw, 1rem);
            min-height: clamp(45px, 7vh, 55px);
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            border: none;
            border-radius: 12px;
            padding: clamp(10px, 2vw, 14px) clamp(18px, 3.5vw, 28px);
            font-weight: bold;
            font-size: clamp(0.9rem, 2.2vw, 1rem);
            min-height: clamp(45px, 7vh, 55px);
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }
        
        .form-range {
            height: clamp(8px, 1.5vh, 12px);
            border-radius: 6px;
            padding: 16px 0; /* Add padding for larger touch target */
            margin: 12px 0; /* Add margin for easier touch interaction */
        }
        
        .form-range::-webkit-slider-thumb {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            width: clamp(32px, 6vw, 44px);
            height: clamp(32px, 6vw, 44px);
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            transition: all 0.2s ease;
            margin-top: -12px; /* Center the thumb on the track */
        }
        
        .form-range::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
        }
        
        .form-range::-webkit-slider-thumb:active {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.6);
        }
        
        .setting-value {
            font-size: clamp(1rem, 2.5vw, 1.1rem);
            font-weight: bold;
            color: #007bff;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .nav-tabs .nav-link {
            border-radius: 10px 10px 0 0;
            border: none;
            background: linear-gradient(45deg, #e9ecef, #f8f9fa);
            color: #495057;
            font-weight: bold;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }
        
        .nav-tabs .nav-link:hover {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }
        
        .form-label {
            font-size: clamp(1rem, 2.2vw, 1.1rem);
            margin-bottom: clamp(0.5rem, 1vh, 0.8rem);
        }
        
        .form-text {
            font-size: clamp(0.85rem, 2vw, 1rem);
        }
        
        /* Responsive container adjustments */
        .container-fluid {
            padding: clamp(0.5rem, 1vw, 1rem);
        }
        
        .main-container {
            max-width: min(95vw, 1000px);
            margin: 0 auto;
        }
        
        .row {
            margin: 0;
            height: 100%;
        }
        
        .col-lg-10, .col-xl-8 {
            padding: 0;
            height: 100%;
        }
        
        .d-grid.gap-3 {
            gap: clamp(1rem, 2vh, 1.5rem) !important;
        }
        
        .tab-content {
            flex-grow: 1;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row justify-content-center h-100">
            <div class="col-lg-10 col-xl-8 h-100">
                <div class="main-container p-3 h-100 d-flex flex-column">
                    <!-- Header -->
                    <div class="d-flex align-items-center mb-2 flex-shrink-0">
                        <a href="/" class="btn btn-outline-secondary me-2">
                            ‚Üê Back
                        </a>
                        <div class="text-center flex-grow-1">
                            <h1 class="fw-bold text-primary mb-0" style="font-size: clamp(1.5rem, 4vw, 2.5rem);">Settings</h1>
                            <p class="text-muted mb-0" style="font-size: clamp(0.9rem, 2vw, 1.1rem);">Configure your Luge Relay system</p>
                        </div>
                        <div style="width: 80px;"></div> <!-- Spacer for centering -->
                    </div>
                    
                    <!-- Navigation Tabs -->
                    <ul class="nav nav-tabs mb-2 flex-shrink-0" id="settingsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="timing-tab" data-bs-toggle="tab" data-bs-target="#timing" type="button" role="tab">
                                Timing Settings
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="server-tab" data-bs-toggle="tab" data-bs-target="#server" type="button" role="tab">
                                Server Settings
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="audio-tab" data-bs-toggle="tab" data-bs-target="#audio" type="button" role="tab">
                                Audio Settings
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="relay-tab" data-bs-toggle="tab" data-bs-target="#relay" type="button" role="tab">
                                Relay Settings
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Tab Content -->
                    <div class="tab-content" id="settingsTabContent">
                        <!-- Timing Settings Tab -->
                        <div class="tab-pane fade show active" id="timing" role="tabpanel">
                            <div class="settings-section">
                                <h3 class="mb-4">Timing Configuration</h3>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label for="defaultDelay1" class="form-label fw-bold">
                                                Default Delay 1: <span id="defaultDelay1Value" class="setting-value">5.0s</span>
                                            </label>
                                            <input type="range" class="form-range" id="defaultDelay1" 
                                                   min="1" max="15" step="0.5" value="5.0">
                                            <div class="form-text">Default time between beep 1 and beep 2</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label for="defaultDelay2" class="form-label fw-bold">
                                                Default Delay 2: <span id="defaultDelay2Value" class="setting-value">8.0s</span>
                                            </label>
                                            <input type="range" class="form-range" id="defaultDelay2" 
                                                   min="1" max="15" step="0.5" value="8.0">
                                            <div class="form-text">Default time between beep 2 and beep 3</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label for="minTotalTime" class="form-label fw-bold">
                                                Min Total Time: <span id="minTotalTimeValue" class="setting-value">6.0s</span>
                                            </label>
                                            <input type="range" class="form-range" id="minTotalTime" 
                                                   min="3" max="12" step="0.5" value="6.0">
                                            <div class="form-text">Minimum allowed total sequence time</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label for="maxTotalTime" class="form-label fw-bold">
                                                Max Total Time: <span id="maxTotalTimeValue" class="setting-value">18.0s</span>
                                            </label>
                                            <input type="range" class="form-range" id="maxTotalTime" 
                                                   min="8" max="25" step="0.5" value="18.0">
                                            <div class="form-text">Maximum allowed total sequence time</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="gateOpenDuration" class="form-label fw-bold">
                                        Gate Open Duration: <span id="gateOpenDurationValue" class="setting-value">1.0s</span>
                                    </label>
                                    <input type="range" class="form-range" id="gateOpenDuration" 
                                           min="0.5" max="5" step="0.1" value="1.0">
                                    <div class="form-text">How long the gate stays open after the final beep</div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="beepRelayAlignment" class="form-label fw-bold">
                                        Beep-Relay Alignment: <span id="beepRelayAlignmentValue" class="setting-value">0.0s</span>
                                    </label>
                                    <input type="range" class="form-range" id="beepRelayAlignment" 
                                           min="-2" max="2" step="0.1" value="0.0">
                                    <div class="form-text">Adjust timing to align final beep with relay signal (negative = beep early, positive = beep late)</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Server Settings Tab -->
                        <div class="tab-pane fade" id="server" role="tabpanel">
                            <div class="settings-section">
                                <h3 class="mb-4">Server Configuration</h3>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label for="serverHost" class="form-label fw-bold">Server Host</label>
                                            <input type="text" class="form-control" id="serverHost" value="0.0.0.0">
                                            <div class="form-text">IP address to bind to (0.0.0.0 for all interfaces)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label for="serverPort" class="form-label fw-bold">Server Port</label>
                                            <input type="number" class="form-control" id="serverPort" value="5000" min="1024" max="65535">
                                            <div class="form-text">Port number for the web server</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-warning">
                                    <strong>Note:</strong> Host and Port changes require restarting the application to take effect.
                                </div>
                                
                                <div class="mb-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="debugMode">
                                        <label class="form-check-label fw-bold" for="debugMode">
                                            Debug Mode
                                        </label>
                                        <div class="form-text">Enable debug logging and auto-reload</div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label for="autoRefreshInterval" class="form-label fw-bold">
                                                Auto Refresh Interval: <span id="autoRefreshIntervalValue" class="setting-value">100ms</span>
                                            </label>
                                            <input type="range" class="form-range" id="autoRefreshInterval" 
                                                   min="50" max="1000" step="50" value="100">
                                            <div class="form-text">How often to update the status display</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label for="countdownUpdateInterval" class="form-label fw-bold">
                                                Countdown Update Interval: <span id="countdownUpdateIntervalValue" class="setting-value">50ms</span>
                                            </label>
                                            <input type="range" class="form-range" id="countdownUpdateInterval" 
                                                   min="25" max="200" step="25" value="50">
                                            <div class="form-text">How often to update the countdown display</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Audio Settings Tab -->
                        <div class="tab-pane fade" id="audio" role="tabpanel">
                            <div class="settings-section">
                                <h3 class="mb-4">Audio Configuration</h3>
                                
                                <div class="mb-4">
                                    <label for="audioVolume" class="form-label fw-bold">
                                        Audio Volume: <span id="audioVolumeValue" class="setting-value">80%</span>
                                    </label>
                                    <input type="range" class="form-range" id="audioVolume" 
                                           min="0" max="100" step="5" value="80">
                                    <div class="form-text">Master volume level for all audio playback</div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <h5 class="alert-heading">Audio Files</h5>
                                    <p class="mb-0">Audio file names are hardcoded and cannot be changed through the interface:</p>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Beep 1:</strong> beep1.wav</li>
                                        <li><strong>Beep 2:</strong> double_beep.wav</li>
                                        <li><strong>Beep 3:</strong> long_beep.wav</li>
                                    </ul>
                                    <p class="mb-0 mt-2">Place these files in the <code>audio/</code> directory.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Relay Settings Tab -->
                        <div class="tab-pane fade" id="relay" role="tabpanel">
                            <div class="settings-section">
                                <h3 class="mb-4">Relay Configuration</h3>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label for="relayPin" class="form-label fw-bold">Relay GPIO Pin</label>
                                            <input type="number" class="form-control" id="relayPin" value="17" min="1" max="40">
                                            <div class="form-text">BCM pin number for relay control</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="relayActiveHigh">
                                                <label class="form-check-label fw-bold" for="relayActiveHigh">
                                                    Active High
                                                </label>
                                                <div class="form-text">Relay activates on HIGH signal</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <h5 class="alert-heading">GPIO Warning</h5>
                                    <p class="mb-0">Changes to relay settings require a restart of the application to take effect. Make sure the GPIO pin is not being used by other processes.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-center flex-shrink-0">
                        <button id="saveSettings" class="btn btn-success">
                            Save Settings
                        </button>
                        <button id="resetSettings" class="btn btn-secondary">
                            Reset to Defaults
                        </button>
                    </div>
                    
                    <!-- Status Messages -->
                    <div id="statusMessage" class="mt-2" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Settings JavaScript -->
    <script>
        // Load settings when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            setupEventListeners();
        });
        
        function loadSettings() {
            fetch('/get_settings')
                .then(response => response.json())
                .then(data => {
                    // Timing settings
                    document.getElementById('defaultDelay1').value = data.default_delay1;
                    document.getElementById('defaultDelay2').value = data.default_delay2;
                    document.getElementById('minTotalTime').value = data.min_total_time;
                    document.getElementById('maxTotalTime').value = data.max_total_time;
                    document.getElementById('gateOpenDuration').value = data.gate_open_duration;
                    document.getElementById('beepRelayAlignment').value = data.beep_relay_alignment || 0.0;
                    
                    // Server settings
                    document.getElementById('serverHost').value = data.host;
                    document.getElementById('serverPort').value = data.port;
                    document.getElementById('debugMode').checked = data.debug;
                    document.getElementById('autoRefreshInterval').value = data.auto_refresh_interval;
                    document.getElementById('countdownUpdateInterval').value = data.countdown_update_interval;
                    
                    // Audio settings
                    document.getElementById('audioVolume').value = data.audio_volume * 100;
                    
                    // Relay settings
                    document.getElementById('relayPin').value = data.relay_pin;
                    document.getElementById('relayActiveHigh').checked = data.relay_active_high;
                    
                    // Update display values
                    updateAllDisplayValues();
                })
                .catch(error => {
                    showMessage('Error loading settings: ' + error.message, 'danger');
                });
        }
        
        function setupEventListeners() {
            // Range sliders
            const rangeInputs = document.querySelectorAll('input[type="range"]');
            rangeInputs.forEach(input => {
                input.addEventListener('input', function() {
                    updateDisplayValue(this);
                });
            });
            
            // Save button
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            
            // Reset button
            document.getElementById('resetSettings').addEventListener('click', resetSettings);
        }
        
        function updateDisplayValue(input) {
            const valueSpan = document.getElementById(input.id + 'Value');
            if (valueSpan) {
                let value = parseFloat(input.value);
                if (input.id === 'audioVolume') {
                    valueSpan.textContent = value + '%';
                } else if (input.id.includes('Interval')) {
                    valueSpan.textContent = value + 'ms';
                } else {
                    valueSpan.textContent = value + 's';
                }
            }
        }
        
        function updateAllDisplayValues() {
            const rangeInputs = document.querySelectorAll('input[type="range"]');
            rangeInputs.forEach(input => {
                updateDisplayValue(input);
            });
        }
        
        function saveSettings() {
            const settings = {
                // Timing settings
                default_delay1: parseFloat(document.getElementById('defaultDelay1').value),
                default_delay2: parseFloat(document.getElementById('defaultDelay2').value),
                min_total_time: parseFloat(document.getElementById('minTotalTime').value),
                max_total_time: parseFloat(document.getElementById('maxTotalTime').value),
                gate_open_duration: parseFloat(document.getElementById('gateOpenDuration').value),
                beep_relay_alignment: parseFloat(document.getElementById('beepRelayAlignment').value),
                
                // Server settings
                host: document.getElementById('serverHost').value,
                port: parseInt(document.getElementById('serverPort').value),
                debug: document.getElementById('debugMode').checked,
                auto_refresh_interval: parseInt(document.getElementById('autoRefreshInterval').value),
                countdown_update_interval: parseInt(document.getElementById('countdownUpdateInterval').value),
                
                // Audio settings
                audio_volume: parseFloat(document.getElementById('audioVolume').value) / 100,
                
                // Relay settings
                relay_pin: parseInt(document.getElementById('relayPin').value),
                relay_active_high: document.getElementById('relayActiveHigh').checked
            };
            
            fetch('/save_settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Settings saved successfully!', 'success');
                } else {
                    showMessage('Error saving settings: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                showMessage('Error saving settings: ' + error.message, 'danger');
            });
        }
        
        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to their default values?')) {
                // Reset to default values
                document.getElementById('defaultDelay1').value = 5.0;
                document.getElementById('defaultDelay2').value = 8.0;
                document.getElementById('minTotalTime').value = 6.0;
                document.getElementById('maxTotalTime').value = 18.0;
                document.getElementById('gateOpenDuration').value = 1.0;
                document.getElementById('beepRelayAlignment').value = 0.0;
                
                document.getElementById('serverHost').value = '0.0.0.0';
                document.getElementById('serverPort').value = 5000;
                document.getElementById('debugMode').checked = false;
                document.getElementById('autoRefreshInterval').value = 100;
                document.getElementById('countdownUpdateInterval').value = 50;
                
                document.getElementById('audioVolume').value = 80;
                
                document.getElementById('relayPin').value = 17;
                document.getElementById('relayActiveHigh').checked = true;
                
                updateAllDisplayValues();
                showMessage('Settings reset to defaults. Click Save to apply changes.', 'info');
            }
        }
        
        function showMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `alert alert-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
